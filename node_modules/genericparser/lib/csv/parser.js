var Converter = require("csvtojson").core.Converter;
var fs = require("fs");
var Stream = require('stream');

var CsvAdv = new Converter(true);

CsvAdv.to = function(output) {
    var error = false;
    switch(typeof output) {
        case 'string':
            fs.exists(output, function(exists) {
                if (exists) 
                    this.to.path(output);
                else
                    this.to.string(output);
            });
            break;
        case "object": 
            if (output instanceof Stream) {
               this.to.stream(output);
            }
            else
                error = true;
            break;
        default:
            error = true;
    }
    if (error) 
        this.error(new Error("Invalid mixed argument in to"));
};

CsvAdv.to.stream = function(output) {
    console.log("on est dans csv adv!");
    output.write('{"csvRows":{[');
    var started = false;
    this.on("record_parsed", function(resultRow, row, index) {
        if (started)
            output.write(",");
        output.write(JSON.stringify(resultRow));
        console.log(resultRow);
        if (false === started)
            started = true;
   });
   this.on("end", function() {
       output.write("]}");
   });
   return this;
};

CsvAdv.to.path = function(output) {
    CsvAdv.to.stream(fs.createWriteStream(output));
    return this;
};

CsvAdv.to.string = function(output) {
    console.log(output);
};

var csvParser = function() {
};

csvParser.prototype.from = function(input) {
    //TODO: IMPLEMENTATION DU LEXER -> SET DANS CsvAdv.from.options;
    CsvAdv.from(input);
    return CsvAdv;
};

module.exports = csvParser;