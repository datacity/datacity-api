var fs = require("fs");

function serializeJSON(currentKey, currentObject, result, isArray, isObject) {
    for (var key in currentObject) {
        if (isNaN(parseInt(key)) === false && (typeof currentObject[key] === "string" || typeof currentObject[key] === "number")) {
             result[currentKey] = [];
             result[currentKey] = currentObject;
             break;
        }
        else if ((typeof currentObject[key] === "string" || typeof currentObject[key] === "number") && isArray === false)
            result[currentKey+"_"+key] = currentObject[key];
        else if ((typeof currentObject[key] === "string" || typeof currentObject[key] === "number") && isArray === true) {
            if (!result[currentKey+"_"+key])
                result[currentKey+"_"+key] = currentObject[key];
            else
                result[currentKey+"_"+key] += "/" + currentObject[key];
        }
        if (currentObject[key] instanceof Array && isObject === true)
            serializeJSON(currentKey+"_"+key, currentObject[key], result, false);
        else if (currentObject[key] instanceof Array && isObject === false) 
            serializeJSON(key, currentObject[key], result, true, false);
        else if (currentObject[key] instanceof Object && isArray === false && isObject === true)
            serializeJSON(currentKey+"_"+key, currentObject[key], result, false, true);
        else if (currentObject[key] instanceof Object && isArray === false)
            serializeJSON(key, currentObject[key], result, false, true);
        else if (currentObject[key] instanceof Object && isArray === true)
            serializeJSON(currentKey, currentObject[key], result, true, true);
    }
}

function parseJSON(fileName, noRam, callback) {
      if (fs.existsSync(fileName) === false) {
        console.log("erreur : le fichier n'existe pas !");
        return;
    }
    var stream = fs.createReadStream(fileName);
    var lines = 1;
    var main = [];
    stream.on('data', function(sdata) {
    var json = JSON.parse(sdata.toString().replace(/\\/g, ""));
    var result = {};
    
     
    var keys = Object.keys(json)
    for (var index in keys ) {
        if (json[keys[index]] instanceof Array) {
            if (json[keys[index]][0] && json[keys[index]][0] instanceof Object) {
                for (var obj in json[keys[index]]) {
                    result = {};
                    serializeJSON("", json[keys[index]][obj], result, false, false);
                    if (noRam === true && callback) 
                       callback(result, lines);
                    else if (noRam === false)
                       main.push(result);
                     lines++;
               }
               break;
            }
          }
      }
    })
    .on("end", function() {
      if (callback) {
          if (noRam === true)
            callback(null, lines);
          else 
            callback(main, lines);
      }
       console.log("finit le parsing"); 
    })
    .on('error', function(error){
          console.log(error.message);
    });
}

function parserJSON() {
    this.parse = parseJSON;
    return this;
}

/*parserJSON().parse(__dirname+"/../test/files/input/JSON_TelephonePublic.json", false, function(data, index) {
    var stream = fs.createWriteStream(__dirname+"/../test/files/output/JSON_TelephonePublicParse.json");
    stream.write(JSON.stringify(data));
});

parserJSON().parse(__dirname+"/../test/files/input/JSON_test2.json", false, function(data, index) {
    var stream = fs.createWriteStream(__dirname+"/../test/files/output/JSON_test2Parse.json");
    stream.write(JSON.stringify(data));
});*/

module.exports = parserJSON;